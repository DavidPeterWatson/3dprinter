[gcode_macro Set_Loaded_Tool]
variable_loaded_tool_name: "none"
gcode:
    {% set tool_name = params.TOOL %}
    {% set loaded_tool_name = printer["gcode_macro Set_Loaded_Tool"].loaded_tool_name %}
    RESPOND MSG="{loaded_tool_name} has been unloaded"
    SET_GCODE_VARIABLE MACRO=Set_Loaded_Tool VARIABLE=loaded_tool_name VALUE='"{tool_name}"'
    RESPOND MSG="{tool_name} has been loaded"


[gcode_macro Get_Loaded_Tool]
gcode:
    {% set loaded_tool_name = printer["gcode_macro Set_Loaded_Tool"].loaded_tool_name %}
    RESPOND MSG="{loaded_tool_name} is loaded"


[gcode_macro _Load_Tool]
gcode:
    Check_Carriage_In_Safe_Zone
    {% set tool_name = params.TOOL %}
    {% set loaded_tool_name = printer["gcode_macro Set_Loaded_Tool"].loaded_tool_name %}
    {% if tool_name == loaded_tool_name %}
        RESPOND MSG="{tool_name} is already loaded"
        Check_Carriage_Is_Loaded
    {% elif loaded_tool_name == 'none' %}
        _Load_Tool_Movement TOOL='"{tool_name}"'
    {% else %}
        { action_raise_error("Cannot load " ~ tool_name ~ " because " ~ loaded_tool_name ~ " is already loaded") }
    {% endif %}


[gcode_macro _Load_Tool_Movement]
gcode:
    Check_Carriage_In_Safe_Zone
    Check_Carriage_Is_Empty
    {% set tool_name = params.TOOL %}
    {% set tool = printer["tool " ~ tool_name] %}
    {% set dock = printer["dock " ~ tool.dock] %}
    RESPOND MSG="Loading {tool.name}"
    # Increase Z to safe distance
    G91
    G0 Z{dock.safe_zd}
    _Clear_GCode_Offset
    # Align carriage for loading
    G90
    G0 X{tool.dock_x - dock.load_xd} Y{dock.safe_y} F{dock.loading_speed}
    # Allow unsafe movement
    SET_KINEMATIC_POSITION Y={-dock.load_yd}
    # Move towards dock
    G91
    G0 Y{dock.load_yd} F{dock.loading_speed}
    G4 P{dock.loading_pause}
    # Move towards tool
    G91
    G0 X{dock.load_xd} F{dock.loading_speed}
    G4 P{dock.loading_pause}
    Check_Carriage_Is_Loaded
    # Move tool to safe zone
    G91
    G0 Y{-dock.load_yd} F{dock.loading_speed}
    # Reset safe movement
    SET_KINEMATIC_POSITION Y={dock.safe_y}
    SET_GCODE_OFFSET X={tool.offset_x} Y={tool.offset_y} Z={tool.offset_z} MOVE=1
    Set_Loaded_Tool TOOL='"{tool.name}"'


[gcode_macro _Unload_Tool]
gcode:
    Check_Carriage_In_Safe_Zone
    Check_Carriage_Is_Loaded
    {% set tool_name = params.TOOL %}
    {% set loaded_tool_name = printer["gcode_macro Set_Loaded_Tool"].loaded_tool_name %}
    {% if tool_name == loaded_tool_name %}
        _Unload_Tool_Movement TOOL='"{tool_name}"'
    {% else %}
        {% set message = "Cannot unload " ~ tool_name ~ " because " ~ loaded_tool_name ~ " is loaded" %}
        { action_raise_error(message) }
    {% endif %}


[gcode_macro _Unload_Tool_Movement]
gcode:
    Check_Carriage_In_Safe_Zone
    Check_Carriage_Is_Loaded
    {% set tool_name = params.TOOL %}
    {% set tool = printer["tool " ~ tool_name] %}
    {% set dock = printer["dock " ~ tool.dock] %}
    RESPOND MSG="Unloading {tool_name}"
    # Increase Z to safe distance
    G91
    G0 Z{dock.safe_zd}
    _Clear_GCode_Offset
    # Align Tool
    G90
    G0 X{tool.dock_x} Y{dock.safe_y} F{dock.loading_speed}
    G4 P{dock.loading_pause}
    # Allow unsafe movement
    SET_KINEMATIC_POSITION Y={-dock.load_yd}
    # Move towards dock
    G91
    G0 Y{dock.load_yd} F{dock.loading_speed}
    G4 P{dock.loading_pause}
    # Move away from tool
    G91
    G0 X{-dock.load_xd} F{dock.loading_speed}
    G4 P{dock.loading_pause}
    Check_Carriage_Is_Empty
    # Move carriage to safe zone
    G91
    G0 Y{-dock.load_yd} F{dock.loading_speed}
    # Reset safe movement
    SET_KINEMATIC_POSITION Y=0
    Set_Loaded_Tool TOOL="none"


[gcode_macro _Clear_GCode_Offset]
gcode:
    SET_GCODE_OFFSET X=0 Y=0 Z=0 MOVE=1


[gcode_button Carriage_Loaded_Button]
pin: PG12
press_gcode:
    {% set carriage_loaded = printer["gcode_button Carriage_Loaded_Button"].state %}
    RESPOND MSG="Carriage Loaded Button: {carriage_loaded}"
release_gcode:
    {% set carriage_loaded = printer["gcode_button Carriage_Loaded_Button"].state %}
    RESPOND MSG="Carriage Loaded Button: {carriage_loaded}"


[gcode_macro Check_Carriage_Is_Loaded]
gcode:
    M400
    _Check_Carriage_Is_Loaded


[gcode_macro _Check_Carriage_Is_Loaded]
gcode:
    {% set carriage_loaded = printer["gcode_button Carriage_Loaded_Button"].state %}
    {% if carriage_loaded == "RELEASED" %}
        { action_raise_error("Expecting carriage to have a tool, but tool is not loaded") }
    {% endif %}


[gcode_macro Check_Carriage_Is_Empty]
gcode:
    M400
    _Check_Carriage_Is_Empty


[gcode_macro _Check_Carriage_Is_Empty]
gcode:
    {% set carriage_loaded = printer["gcode_button Carriage_Loaded_Button"].state %}
    {% if carriage_loaded == "PRESSED" %}
        { action_raise_error("Expecting carriage to be empty, but tool is loaded") }
    {% endif %}


[gcode_button Unsafe_Zone_Button]
pin: PG13
press_gcode:
    {% set in_unsafe_zone = printer["gcode_button Unsafe_Zone_Button"].state %}
    RESPOND MSG="Unsafe Zone: {in_unsafe_zone}"
release_gcode:
    {% set in_unsafe_zone = printer["gcode_button Unsafe_Zone_Button"].state %}
    RESPOND MSG="Unsafe Zone: {in_unsafe_zone}"


[gcode_macro Check_Carriage_In_Safe_Zone]
gcode:
    M400
    _Check_Carriage_In_Safe_Zone


[gcode_macro _Check_Carriage_In_Safe_Zone]
gcode:
    {% set carriage_in_unsafe_zone = printer["gcode_button Unsafe_Zone_Button"].state %}
    {% if carriage_in_unsafe_zone == "PRESSED" %}
        { action_raise_error("Expecting carriage to be in safe zone, but it is in unsafe zone") }
    {% endif %}


[gcode_macro Check_Carriage_In_Unsafe_Zone]
gcode:
    M400
    _Check_Carriage_In_Unsafe_Zone


[gcode_macro _Check_Carriage_In_Unsafe_Zone]
gcode:
    {% set carriage_in_unsafe_zone = printer["gcode_button Unsafe_Zone_Button"].state %}
    {% if carriage_in_unsafe_zone == "RELEASED" %}
        { action_raise_error("Expecting carriage to be in unsafe zone, but it is in safe zone") }
    {% endif %}


[dock front]
safe_y: 0.0
safe_zd: 20.0
load_yd: -100.0 # Movement from safe_y to engage tool
load_xd: 20.0 # Movement on x to engage tool
loading_speed: 10.0
loading_pause: 500.0
