[firmware_retraction]
retract_length: 6
retract_speed: 200
unretract_speed: 200


[servo extruder_cleaner_servo]
pin: PG15
maximum_servo_angle: 90
minimum_pulse_width: 0.001
maximum_pulse_width: 0.002
initial_angle: 0


[gcode_macro M104]
description: Override "M104" to allow multiple extruders.
rename_existing: M104.1
gcode:
    {% set temperature = params.S|default(0)|float %}
    {% set extruder = params.T|default(-1)|int %}
    {% if extruder != -1 %} ; Ignore if extruder not specified
        M104.1 S{temperature} T{extruder}
    {% endif %}


[gcode_macro M109]
description: Override "M109" to allow multiple extruders.
rename_existing: M109.1
gcode:
    {% set temperature = params.S|default(0)|float %}
    {% set extruder = params.T|default(-1)|int %}
    {% if extruder != -1 %} ; Ignore if extruder not specified
        M109.1 S{temperature} T{extruder}
    {% endif %}


[gcode_macro SET_RETRACTION_FOR_EXTRUDER]
description: Set Retraction Settings for Extruder
gcode:
    RESPOND MSG="Setting retraction settings for Extruder"
    SET_RETRACTION RETRACT_SPEED=100 UNRETRACT_SPEED=100 RETRACT_LENGTH={params.RETRACT_LENGTH}


[gcode_macro RETRACT_FROM_HOT_ZONE]
gcode:
    {% if printer.extruder.can_extrude %}
        SAVE_GCODE_STATE NAME=RETRACT_FROM_HOT_ZONE_STATE
        G91
        G1 X5 Y5 E-5 F4800
        G1 Z2 E-15 F4800
        RESTORE_GCODE_STATE NAME=RETRACT_FROM_HOT_ZONE_STATE
    {% endif %}


[gcode_macro UNRETRACT_INTO_HOT_ZONE]
gcode:
    {% if printer.extruder.can_extrude %}
        SAVE_GCODE_STATE NAME=UNRETRACT_INTO_HOT_ZONE_STATE
        M83
        G1 E20 F4800
        RESTORE_GCODE_STATE NAME=UNRETRACT_INTO_HOT_ZONE_STATE
    {% endif %}


[gcode_macro CLEAN_EXTRUDER]
description: Clean the current extruder
gcode:
    MOVE_BED_BELOW_CLEANER
    MOVE_OVER_CLEANER
    OPEN_CLEANER
    UNRETRACT_INTO_HOT_ZONE
    PURGE_AND_WIPE
    G10 ; retract
    CLOSE_CLEANER


[gcode_macro MOVE_OVER_CLEANER]
description: Move the current tool above the cleaner
gcode:
    RESPOND MSG='Moving over cleaner'
    SAVE_GCODE_STATE NAME=MOVE_OVER_CLEANER_STATE
    Move_To_Safe_Z
    USE_ABSOLUTE_POSITIONING_WITH_RELATIVE_EXTRUSION
    G0 X-40 Y500 F7200
    RESTORE_GCODE_STATE NAME=MOVE_OVER_CLEANER_STATE


[gcode_macro OPEN_CLEANER]
gcode:
    SET_SERVO SERVO=extruder_cleaner_servo ANGLE=90


[gcode_macro CLOSE_CLEANER]
gcode:
    SET_SERVO SERVO=extruder_cleaner_servo ANGLE=0


[gcode_macro PURGE_AND_WIPE]
gcode:
    SAVE_GCODE_STATE NAME=WIPE_STATE
    USE_ABSOLUTE_POSITIONING_WITH_RELATIVE_EXTRUSION
    RESPOND MSG='Purging'
    G1 E30 F500
    RESPOND MSG='Wiping'
    G0 Y550 F3600
    RESTORE_GCODE_STATE NAME=WIPE_STATE


[gcode_macro MOVE_BED_BELOW_CLEANER]
gcode:
    M400
    _MOVE_BED_BELOW_CLEANER


[gcode_macro _MOVE_BED_BELOW_CLEANER]
gcode:
    {% set carriage_changer = printer.printer.lookup_object('carriage_changer') %}
    {% if printer.toolhead.position.z < 40 %}
        SAVE_GCODE_STATE NAME=MOVE_BED_BELOW_CLEANER_STATE
        G90
        G0 Z40
        RESTORE_GCODE_STATE NAME=MOVE_BED_BELOW_CLEANER_STATE
    {% endif %}
